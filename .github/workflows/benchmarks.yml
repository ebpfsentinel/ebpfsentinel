name: Benchmarks

on:
  push:
    branches: [main]
    paths:
      - "crates/domain/**"
      - "crates/ebpf-common/**"
      - "Cargo.toml"
      - "Cargo.lock"
  pull_request:
    branches: [main]
    paths:
      - "crates/domain/**"
      - "crates/ebpf-common/**"
      - "Cargo.toml"
      - "Cargo.lock"
  workflow_dispatch:
  schedule:
    - cron: "0 4 * * 1" # Weekly Monday 4am UTC

env:
  CARGO_TERM_COLOR: always

concurrency:
  group: bench-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ── Compile benchmarks ───────────────────────────────────────────────
  bench-compile:
    name: Compile benchmarks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: bench
      - run: cargo bench --no-run -p domain

  # ── Run domain benchmarks ───────────────────────────────────────────
  bench-domain:
    name: Domain benchmarks
    runs-on: ubuntu-latest
    needs: [bench-compile]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: bench

      - name: Run benchmarks
        run: cargo bench -p domain -- --output-format bencher 2>&1 | tee bench-output.txt

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: criterion-reports
          path: target/criterion/
          retention-days: 30

      - name: Upload raw output
        uses: actions/upload-artifact@v4
        with:
          name: bench-output
          path: bench-output.txt
          retention-days: 30

      - name: Check for regressions (PR only)
        if: github.event_name == 'pull_request'
        run: |
          # Parse benchmark output for significant regressions (>20% slower)
          if grep -E "change:.*\+[2-9][0-9]\." bench-output.txt; then
            echo "::warning::Significant benchmark regression detected (>20%). Review the criterion reports."
          fi
