name: Integration Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Nightly at 03:00 UTC
    - cron: '0 3 * * *'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: -Dwarnings

concurrency:
  group: integration-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ── Build agent binary and eBPF programs ─────────────────────────
  build:
    name: Build Agent
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: rust-src

      - uses: Swatinem/rust-cache@v2

      - name: Install protoc
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Build eBPF programs
        run: cargo xtask ebpf-build
        continue-on-error: true

      - name: Build agent (release)
        run: cargo build --release --bin ebpfsentinel-agent

      - name: Upload agent binary
        uses: actions/upload-artifact@v4
        with:
          name: ebpfsentinel-agent
          path: target/release/ebpfsentinel-agent
          retention-days: 1

  # ── API integration tests (suites 01-05 + 07) ───────────────────
  test-api:
    name: API Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Download agent binary
        uses: actions/download-artifact@v4
        with:
          name: ebpfsentinel-agent
          path: target/release/

      - name: Make agent executable
        run: chmod +x target/release/ebpfsentinel-agent

      - name: Install BATS
        run: |
          git clone --depth 1 https://github.com/bats-core/bats-core.git /tmp/bats-core
          sudo /tmp/bats-core/install.sh /usr/local
          rm -rf /tmp/bats-core

      - name: Install grpcurl
        run: |
          GRPCURL_VERSION="1.9.1"
          curl -sSL "https://github.com/fullstorydev/grpcurl/releases/download/v${GRPCURL_VERSION}/grpcurl_${GRPCURL_VERSION}_linux_x86_64.tar.gz" | \
            sudo tar -xz -C /usr/local/bin grpcurl

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y jq openssl

      - name: Generate TLS certificates
        run: bash tests/integration/scripts/generate-certs.sh

      - name: Generate JWT keys and tokens
        run: bash tests/integration/scripts/generate-jwt-keys.sh

      - name: Suite 01 — Agent Lifecycle
        run: bats --timing tests/integration/suites/01-agent-lifecycle.bats

      - name: Suite 02 — REST API Health
        run: bats --timing tests/integration/suites/02-rest-api-health.bats

      - name: Suite 03 — Firewall CRUD
        run: bats --timing tests/integration/suites/03-rest-api-firewall.bats

      - name: Suite 04 — Domain APIs
        run: bats --timing tests/integration/suites/04-rest-api-domains.bats

      - name: Suite 05 — gRPC Streaming
        run: bats --timing tests/integration/suites/05-grpc-streaming.bats

      - name: Suite 07 — Authentication & RBAC
        run: bats --timing tests/integration/suites/07-authentication.bats

      - name: Suite 08 — TLS
        run: bats --timing tests/integration/suites/08-tls.bats

  # ── Docker deployment tests (suite 09) ───────────────────────────
  test-docker:
    name: Docker Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Download agent binary
        uses: actions/download-artifact@v4
        with:
          name: ebpfsentinel-agent
          path: target/release/

      - name: Make agent executable
        run: chmod +x target/release/ebpfsentinel-agent

      - name: Install BATS
        run: |
          git clone --depth 1 https://github.com/bats-core/bats-core.git /tmp/bats-core
          sudo /tmp/bats-core/install.sh /usr/local
          rm -rf /tmp/bats-core

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Suite 09 — Docker Deployment
        run: bats --timing tests/integration/suites/09-docker.bats

  # ── eBPF tests (suite 06 — gated to main/dispatch) ──────────────
  test-ebpf:
    name: eBPF Tests
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4

      - name: Download agent binary
        uses: actions/download-artifact@v4
        with:
          name: ebpfsentinel-agent
          path: target/release/

      - name: Make agent executable
        run: chmod +x target/release/ebpfsentinel-agent

      - name: Install BATS
        run: |
          git clone --depth 1 https://github.com/bats-core/bats-core.git /tmp/bats-core
          sudo /tmp/bats-core/install.sh /usr/local
          rm -rf /tmp/bats-core

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          # Try kernel-specific package first, then generic linux-tools-common
          sudo apt-get install -y "linux-tools-$(uname -r)" 2>/dev/null \
            || sudo apt-get install -y linux-tools-common linux-tools-generic 2>/dev/null \
            || echo "::warning::bpftool not available — eBPF tests will be skipped"

      - name: Suite 06 — eBPF Programs
        run: sudo bats --timing tests/integration/suites/06-ebpf-programs.bats
